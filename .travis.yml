sudo: required

language: bash

env:
  global:
      - DEPLOY_HOST=rpm.palette-software.com
      - DEPLOY_PATH=/var/palette-rpm-repo
      - DEPLOY_USER=palette-rpm
      - RPM_VERSION=1.0.$TRAVIS_BUILD_NUMBER

      # travis encrypt DEPLOY_PASS=...
      - secure: "RSneIngDU6k3qXxovaLkQGaoswsfjOAR+DWQ9aHqmDSoUsYWmsYnnVfZxAS0rJ76XPKCcf5cbW70XYOozw2rN2geDyg9deQXvWLn2ckd/uOsCxvLvuOmWitmZPLNNblIBaYKX1seL+v8h8cjnlbhb76IEEBrBEoSpbJUN33vCnN13eV7jt4pnhwHOzzqXM8qHNX4K1MuiW5NN/Zk5+qqTscCrc7pvbshP9JaGc8OvxiXFS9yyAauSxSnL1wtJmYSwPh+FSM9NZmr8+PnvEmvP/R6ETGVouS4hpdtWGAveLGcKoOnv+yA1dWUfNT3U24rEPA+qNvGUx2OTqRbUM8cDS/D8uBCjFcXmREgDB899TXIZDaXhBuk4enPMm0W0pNlupnXrx4hTScXx9dslr/yPA7tyldvg+C+f6pe16eo2zK7MJo6x/vKX7EZjX/IGbHWBNBSvpco+jxhdEve0MQl8GY3/v3OSamy+bLyCBgkyPhfC+3KV8TYTsrYQSWUIkuci4xeSu9rorbHv41jE6/Vw5O5aBMjN4vAxw5/XkrmoML4Ppi7f41ho/w7jlJqDOOhk93macgLqSIWuNK50dxkdONsraI1sDT+lgDoUQMy5ONX9zjv7E56qqKoSZRJAJ8PE5rmnChY739ehbM+dFovwDgWyYdSdoEDF3ztXQK1Tlw="

# install the RPM package
addons:
  apt:
    packages:
      - rpm
      # To deploy the rpms, we need to ssh into places, and we dont want to store keys for now
      - sshpass

script:
  - pushd rpm-build
  # # Freeze the dependencies of requirements
  - export SPEC_FILE=palette-insight.spec
  # - ./freeze-requirement.sh palette-insight-toolkit ${SPEC_FILE}
  # - ./freeze-requirement.sh palette-insight-website ${SPEC_FILE}
  # - ./freeze-requirement.sh palette-insight-agent ${SPEC_FILE}
  # - ./freeze-requirement.sh palette-insight-server ${SPEC_FILE}
  # - ./freeze-requirement.sh palette-insight-gp-import ${SPEC_FILE}
  # - ./freeze-requirement.sh palette-insight-reporting ${SPEC_FILE}
  # # Show the contents of the modified (frozen versions) spec file
  # - cat ${SPEC_FILE}

  # build the rpm
  - mkdir _build
  - rpmbuild -bb --buildroot $(pwd) --define "version $RPM_VERSION" --define "buildrelease $TRAVIS_BUILD_NUMBER" --define "_rpmdir $(pwd)/_build" ${SPEC_FILE}
  - popd

deploy:
  provider: script
  script: "./deploy.sh"
  skip_cleanup: true
  on:
    branch: master
    tags: false

notifications:
  email:
    on_success: never
    on_failure: never
